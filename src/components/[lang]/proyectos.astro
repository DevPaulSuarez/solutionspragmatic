---
import { sanity } from '../../lib/sanity';
import groq from 'groq';
import { translations, supportedLangs, defaultLang } from '../../i18n/translations';

// ✅ Primero definimos 'lang'
const lang = Astro.params.lang || 'es';

// ✅ Luego lo validamos
if (!supportedLangs.includes(lang)) {
  throw Astro.redirect(`/${defaultLang}`);
}

// ✅ Traducciones por idioma
const t = translations[lang];

// ✅ Consulta a Sanity
const query = groq`*[_type == "project" && language == $lang]{
  _id,
  title,
  description,
  "imageUrl": image.asset->url,
  technologies
}`;

const proyectos = await sanity.fetch(query, { lang });
---
<html>
  <head>
    <title>{t.projectsTitle}</title>
  </head>
  <body>
    <h1>{t.projectsTitle}</h1>

    {proyectos.map(proyecto => (
      <div style="margin-bottom: 2rem;" key={proyecto._id}>
        <h2>{proyecto.title}</h2>
        <img src={proyecto.imageUrl} alt={proyecto.title} style="width: 300px;" />
        <p>{proyecto.description}</p>
        <ul>
          {proyecto.technologies.map(tech => <li>{tech}</li>)}
        </ul>
      </div>
    ))}
  </body>
</html>
